define(["@grafana/runtime","react","@grafana/ui","@grafana/data"],((e,t,n,a)=>(()=>{"use strict";var o={305:e=>{e.exports=a},545:t=>{t.exports=e},388:e=>{e.exports=n},650:e=>{e.exports=t}},s={};function i(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return o[e](n,n.exports,i),n.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};return(()=>{i.r(r),i.d(r,{plugin:()=>C});var e=i(545);function t(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class n extends e.DataSourceWithBackend{fetchInstallations(){return this.backendSrv.datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/installationinfo`}).then((e=>e.data))}fetchFunctions(e){return this.backendSrv.datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/functionx/${e}`}).then((e=>e.data))}testDatasource(){return new Promise(((e,t)=>{this.backendSrv.datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/installationinfo`}).then((t=>{e({status:"success",message:"All good!"})})).catch((e=>{t({status:"error",message:e.statusText})}))}))}constructor(e,n){super(e),t(this,"backendSrv",void 0),t(this,"settings",void 0),this.backendSrv=n,this.settings=e}}var a=i(650),o=i.n(a),s=i(388);function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){l(e,t,n[t])}))}return e}function c(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const{FormField:h}=s.LegacyForms;class p extends a.PureComponent{componentDidMount(){}render(){const{options:e}=this.props,{jsonData:t}=e;return o().createElement("div",{className:"gf-form-group"},o().createElement("div",{className:"gf-form"},o().createElement(h,{label:"URL",inputWidth:24,labelWidth:6,onChange:this.onURLChange,value:t.url||"",placeholder:"https://aam.iotopen.se"})),o().createElement("div",{className:"gf-form"},o().createElement(h,{label:"API Key",inputWidth:24,labelWidth:6,onChange:this.onAPIKeyChange,value:t.apiKey||"",placeholder:"Your API key"})))}constructor(...e){super(...e),l(this,"onAPIKeyChange",(e=>{const{onOptionsChange:t,options:n}=this.props,a=c(u({},n.jsonData),{apiKey:e.target.value});t(c(u({},n),{jsonData:a}))})),l(this,"onURLChange",(e=>{const{onOptionsChange:t,options:n}=this.props,a=c(u({},n.jsonData),{url:e.target.value});t(c(u({},n),{jsonData:a}))}))}}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class m extends a.PureComponent{shouldComponentUpdate(e,t,n){return!0}render(){const e=[],t=[];if(this.props.keys)for(const t of this.props.keys)e.push({label:t,value:t});if(this.props.values)for(const e of this.props.values)t.push({label:e,value:e});return o().createElement("div",{className:"gf-form-inline"},o().createElement("div",{className:"gf-form"},o().createElement("span",{className:"gf-form-label query-keyword"},"key"),o().createElement(s.Select,{width:30,options:e,onChange:this.onChangeKey,onCreateOption:this.onChangeKey,value:{label:this.props.data.key,value:this.props.data.key},isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"meta key"}),o().createElement("span",{className:"gf-form-label query-keyword"},"match"),o().createElement(s.Select,{width:30,options:t,onChange:this.onChangeValue,onCreateOption:this.onChangeValue,value:{label:this.props.data.value,value:this.props.data.value},isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"wildcard match"}),o().createElement(s.Button,{variant:"destructive",onClick:this.onDelete},"X")))}constructor(e){super(e),d(this,"onChangeKey",(e=>{"string"==typeof e?this.props.onUpdate(this.props.idx,e,this.props.data.value):this.props.onUpdate(this.props.idx,e.label,this.props.data.value)})),d(this,"onChangeValue",(e=>{console.log(e),"string"==typeof e?this.props.onUpdate(this.props.idx,this.props.data.key,e):this.props.onUpdate(this.props.idx,this.props.data.key,e.value)})),d(this,"onDelete",(()=>{this.props.onDelete(this.props.idx)}))}}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){g(e,t,n[t])}))}return e}function f(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const{FormField:b,Switch:v}=s.LegacyForms;class O extends a.PureComponent{componentDidMount(){this.props.datasource.fetchInstallations().then((e=>{let t={id:0,client_id:0,name:""};if(e.length>0&&(t=e[0]),0!==this.props.query.installationId){const n=e.find((e=>e.id===this.props.query.installationId));void 0!==n&&(t=n)}this.onSelectInstallation({value:t}),this.setState({installations:e,loadingInstallations:!1,selectedInstallation:{value:t}})}))}onRunQuery(){if(this.state.ticker){clearTimeout(this.state.ticker);const e=setTimeout((()=>{this.props.onRunQuery()}),250);this.setState({ticker:e})}else{const e=setTimeout((()=>{this.props.onRunQuery()}),250);this.setState({ticker:e})}}getInstallationOptionLabel(e){return null==e.value?"":e.value.name}getMetaKeys(){const e=["id","type"];for(const t of this.state.functions)for(const n in t.meta)-1===e.indexOf(n)&&e.push(n);return e}getMetaValues(e){const t=[];for(const n of this.state.functions){let a=n.meta[e];"type"===e&&(a=n.type),"id"===e&&(a=n.id.toString()),a&&-1===t.indexOf(a)&&t.push(a)}return t}render(){const e=this.props.query;return null==e.meta&&(e.installationId=0,e.clientId=0,e.meta=[{key:"type",value:""}]),o().createElement("div",{className:"section gf-form-group"},o().createElement("div",{className:"gf-form-inline"},o().createElement(s.Select,{isLoading:this.state.loadingInstallations,width:65,getOptionLabel:this.getInstallationOptionLabel,options:this.state.installations.map((e=>({value:e}))),menuPlacement:"bottom",onChange:this.onSelectInstallation,value:this.state.selectedInstallation})),o().createElement("div",{className:"gf-form-inline,ui-list"},e.meta.map(((e,t)=>o().createElement(m,{key:t,idx:t,data:e,onDelete:this.onMetaDelete,onUpdate:this.onMetaUpdate,keys:this.getMetaKeys(),values:this.getMetaValues(e.key)})))),o().createElement("div",{className:"gf-form-inline",style:{paddingBottom:10}},o().createElement(s.Button,{onClick:this.addFilter},"Add filter")),o().createElement("div",{className:"gf-form-inline"},o().createElement(b,{labelWidth:40,label:"Group by",onChange:this.onGroupByChange,value:e.groupBy,tooltip:this.tooltipGroupBy}),o().createElement(b,{labelWidth:40,label:"Name by",onChange:this.onNameByChange,value:e.nameBy,tooltip:this.tooltipNameBy})),o().createElement("div",{className:"gf-form-inline"},o().createElement(v,{label:"As table data",checked:e.tabledata,onChange:this.onDatatable}),o().createElement("div",{hidden:!e.tabledata},o().createElement(b,{labelWidth:40,label:"Message from",onChange:this.onMessageChange,value:e.messageFrom,tooltip:this.tooltipMessageFrom}),o().createElement(b,{labelWidth:40,label:"Linked with",onChange:this.onLinkChange,value:e.linkKey}),o().createElement("div",null,o().createElement(v,{label:"Meta to fields",checked:e.metaAsFields,onChange:this.onMetaAsFields}),o().createElement("div",{hidden:!e.metaAsFields},o().createElement(v,{label:"Add device meta",checked:e.joinDeviceMeta,onChange:this.onDeviceMetaJoin}))))),o().createElement(v,{label:"Current state only",checked:e.stateOnly,onChange:this.onStateOnlyChange}))}constructor(e){super(e),g(this,"onSelectInstallation",(e=>{const{onChange:t,query:n}=this.props;null!=e.value&&(this.setState({selectedInstallation:e}),t(f(y({},n),{installationId:e.value.id,clientId:e.value.client_id})),this.props.datasource.fetchFunctions(Number(e.value.id)).then((t=>{void 0!==e.value&&this.state.selectedInstallation.value===e.value&&(this.setState({functions:t,selectedInstallation:e}),this.props.onRunQuery())})))})),g(this,"addFilter",(()=>{const{onChange:e,query:t}=this.props;t.meta.push({key:"",value:""}),e(f(y({},t),{meta:t.meta}))})),g(this,"onMetaDelete",(e=>{const{onChange:t,query:n}=this.props;n.meta=n.meta.filter(((t,n)=>!(e===n))),t(f(y({},n),{meta:n.meta})),this.props.onRunQuery()})),g(this,"onMetaUpdate",((e,t,n)=>{const{onChange:a,query:o}=this.props;o.meta[e].key=t,o.meta[e].value=n,a(f(y({},o),{meta:o.meta})),this.onRunQuery()})),g(this,"onMessageChange",(e=>{const{onChange:t,query:n}=this.props;t(f(y({},n),{messageFrom:e.target.value})),this.onRunQuery()})),g(this,"onGroupByChange",(e=>{const{onChange:t,query:n}=this.props;t(f(y({},n),{groupBy:e.target.value})),this.onRunQuery()})),g(this,"onNameByChange",(e=>{const{onChange:t,query:n}=this.props;t(f(y({},n),{nameBy:e.target.value})),this.onRunQuery()})),g(this,"onLinkChange",(e=>{const{onChange:t,query:n}=this.props;t(f(y({},n),{linkKey:e.target.value})),this.onRunQuery()})),g(this,"onStateOnlyChange",(()=>{const{onChange:e,query:t}=this.props;e(f(y({},t),{stateOnly:!t.stateOnly})),this.props.onRunQuery()})),g(this,"onDatatable",(()=>{const{onChange:e,query:t}=this.props;e(f(y({},t),{tabledata:!t.tabledata})),this.props.onRunQuery()})),g(this,"onMetaAsFields",(()=>{const{onChange:e,query:t}=this.props;e(f(y({},t),{metaAsFields:!t.metaAsFields})),this.props.onRunQuery()})),g(this,"onDeviceMetaJoin",(()=>{const{onChange:e,query:t}=this.props;e(f(y({},t),{joinDeviceMeta:!t.joinDeviceMeta})),this.props.onRunQuery()})),g(this,"tooltipGroupBy",o().createElement(o().Fragment,null,"Group series by some meta key or payload ",o().createElement("code",null,"msg")," field. Defaults to Function ID.")),g(this,"tooltipNameBy",o().createElement(o().Fragment,null,"This will name series based on some meta key.",o().createElement("br",null),"Defaults to ",o().createElement("code",null,"name"),".")),g(this,"tooltipMessageFrom",o().createElement(o().Fragment,null,"Using this field will join matching functions with the same filter, but the type changed to this field. The msg field will be overwritten by messages matching this type, linked through ",o().createElement("code",null,"device_id")," meta key. Useful for eg. joining positional data. ",o().createElement("br",null),"This field is only applied on table data.")),this.state={installations:[],functions:[],selectedInstallation:{value:{id:0,name:"",client_id:0}},ticker:null,loadingInstallations:!0}}}const C=new(i(305).DataSourcePlugin)(n).setConfigEditor(p).setQueryEditor(O)})(),r})()));
//# sourceMappingURL=module.js.map