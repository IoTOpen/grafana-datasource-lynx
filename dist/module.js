define(["@grafana/runtime","react","@grafana/ui","@grafana/data"],((e,t,n,a)=>(()=>{"use strict";var o={305:e=>{e.exports=a},545:t=>{t.exports=e},388:e=>{e.exports=n},650:e=>{e.exports=t}},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return o[e](n,n.exports,r),n.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{r.r(i),r.d(i,{plugin:()=>E});var e=r(545);function t(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function n(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{},o=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),o.forEach((function(n){t(e,n,a[n])}))}return e}function a(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}class o extends e.DataSourceWithBackend{fetchInstallations(){return(0,e.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/installationinfo`}).then((e=>e.data))}fetchFunctions(t){return(0,e.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/functionx/${t}`}).then((e=>e.data))}testDatasource(){return new Promise(((t,n)=>{(0,e.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/installationinfo`}).then((e=>{t({status:"success",message:"All good!"})})).catch((e=>{n({status:"error",message:e.statusText})}))}))}query(t){const o=(0,e.getTemplateSrv)(),s=t.targets.map((e=>a(n({},e),{meta:e.meta.map((e=>({key:o.replace(e.key),value:o.replace(e.value)})))})));return super.query(a(n({},t),{targets:s}))}constructor(e){super(e),t(this,"settings",void 0),this.settings=e}}var s=r(650),l=r.n(s),c=r(388);function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){u(e,t,n[t])}))}return e}function h(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const{FormField:d}=c.LegacyForms;class m extends s.PureComponent{componentDidMount(){}render(){const{options:e}=this.props,{jsonData:t}=e;return l().createElement("div",{className:"gf-form-group"},l().createElement("div",{className:"gf-form"},l().createElement(d,{label:"URL",inputWidth:24,labelWidth:6,onChange:this.onURLChange,value:t.url||"",placeholder:"https://lynx.iotopen.se"})),l().createElement("div",{className:"gf-form"},l().createElement(d,{label:"API Key",inputWidth:24,labelWidth:6,onChange:this.onAPIKeyChange,value:t.apiKey||"",placeholder:"Your API key"})))}constructor(...e){super(...e),u(this,"onAPIKeyChange",(e=>{const{onOptionsChange:t,options:n}=this.props,a=h(p({},n.jsonData),{apiKey:e.target.value});t(h(p({},n),{jsonData:a}))})),u(this,"onURLChange",(e=>{const{onOptionsChange:t,options:n}=this.props,a=h(p({},n.jsonData),{url:e.target.value});t(h(p({},n),{jsonData:a}))}))}}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class g extends s.PureComponent{shouldComponentUpdate(e,t,n){return!0}render(){const e=[],t=[];if(this.props.keys)for(const t of this.props.keys)e.push({label:t,value:t});if(this.props.values)for(const e of this.props.values)t.push({label:e,value:e});return l().createElement("div",{className:"gf-form-inline"},l().createElement("div",{className:"gf-form"},l().createElement("span",{className:"gf-form-label query-keyword"},"key"),l().createElement(c.Select,{width:30,options:e,onChange:this.onChangeKey,onCreateOption:this.onChangeKey,value:{label:this.props.data.key,value:this.props.data.key},isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"meta key"}),l().createElement("span",{className:"gf-form-label query-keyword"},"match"),l().createElement(c.Select,{width:30,options:t,onChange:this.onChangeValue,onCreateOption:this.onChangeValue,value:{label:this.props.data.value,value:this.props.data.value},isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"wildcard match"}),l().createElement(c.Button,{variant:"destructive",onClick:this.onDelete},"X")))}constructor(e){super(e),y(this,"onChangeKey",(e=>{"string"==typeof e?this.props.onUpdate(this.props.idx,e,this.props.data.value):this.props.onUpdate(this.props.idx,e.label,this.props.data.value)})),y(this,"onChangeValue",(e=>{console.log(e),"string"==typeof e?this.props.onUpdate(this.props.idx,this.props.data.key,e):this.props.onUpdate(this.props.idx,this.props.data.key,e.value)})),y(this,"onDelete",(()=>{this.props.onDelete(this.props.idx)}))}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function b(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){f(e,t,n[t])}))}return e}function v(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const{FormField:O,Switch:C}=c.LegacyForms;class j extends s.PureComponent{componentDidMount(){this.props.datasource.fetchInstallations().then((e=>{let t={id:0,client_id:0,name:""};if(e.length>0&&(t=e[0]),0!==this.props.query.installationId){const n=e.find((e=>e.id===this.props.query.installationId));void 0!==n&&(t=n)}this.onSelectInstallation({value:t}),this.setState({installations:e,loadingInstallations:!1,selectedInstallation:{value:t}})}))}onRunQuery(){if(this.state.ticker){clearTimeout(this.state.ticker);const e=setTimeout((()=>{this.props.onRunQuery()}),250);this.setState({ticker:e})}else{const e=setTimeout((()=>{this.props.onRunQuery()}),250);this.setState({ticker:e})}}getInstallationOptionLabel(e){return null==e.value?"":e.value.name}getMetaKeys(){const e=["id","type"];for(const t of this.state.functions)for(const n in t.meta)-1===e.indexOf(n)&&e.push(n);return e}getMetaValues(e){const t=[];for(const n of this.state.functions){let a=n.meta[e];"type"===e&&(a=n.type),"id"===e&&(a=n.id.toString()),a&&-1===t.indexOf(a)&&t.push(a)}return t}render(){const e=this.props.query;return null==e.meta&&(e.installationId=0,e.clientId=0,e.meta=[{key:"type",value:""}]),l().createElement("div",{className:"section gf-form-group"},l().createElement("div",{className:"gf-form-inline"},l().createElement(c.Select,{isLoading:this.state.loadingInstallations,width:65,getOptionLabel:this.getInstallationOptionLabel,options:this.state.installations.map((e=>({value:e}))),menuPlacement:"bottom",onChange:this.onSelectInstallation,value:this.state.selectedInstallation})),l().createElement("div",{className:"gf-form-inline,ui-list"},e.meta.map(((e,t)=>l().createElement(g,{key:t,idx:t,data:e,onDelete:this.onMetaDelete,onUpdate:this.onMetaUpdate,keys:this.getMetaKeys(),values:this.getMetaValues(e.key)})))),l().createElement("div",{className:"gf-form-inline",style:{paddingBottom:10}},l().createElement(c.Button,{onClick:this.addFilter},"Add filter")),l().createElement("div",{className:"gf-form-inline"},l().createElement(O,{labelWidth:40,label:"Group by",onChange:this.onGroupByChange,value:e.groupBy,tooltip:this.tooltipGroupBy}),l().createElement(O,{labelWidth:40,label:"Name by",onChange:this.onNameByChange,value:e.nameBy,tooltip:this.tooltipNameBy})),l().createElement("div",{className:"gf-form-inline"},l().createElement(C,{label:"As table data",checked:e.tabledata,onChange:this.onDatatable}),l().createElement("div",{hidden:!e.tabledata},l().createElement(O,{labelWidth:40,label:"Message from",onChange:this.onMessageChange,value:e.messageFrom,tooltip:this.tooltipMessageFrom}),l().createElement(O,{labelWidth:40,label:"Linked with",onChange:this.onLinkChange,value:e.linkKey}),l().createElement("div",null,l().createElement(C,{label:"Meta to fields",checked:e.metaAsFields,onChange:this.onMetaAsFields}),l().createElement("div",{hidden:!e.metaAsFields},l().createElement(C,{label:"Add device meta",checked:e.joinDeviceMeta,onChange:this.onDeviceMetaJoin}))))),l().createElement(C,{label:"Current state only",checked:e.stateOnly,onChange:this.onStateOnlyChange}))}constructor(e){super(e),f(this,"onSelectInstallation",(e=>{const{onChange:t,query:n}=this.props;null!=e.value&&(this.setState({selectedInstallation:e}),t(v(b({},n),{installationId:e.value.id,clientId:e.value.client_id})),this.props.datasource.fetchFunctions(Number(e.value.id)).then((t=>{void 0!==e.value&&this.state.selectedInstallation.value===e.value&&(this.setState({functions:t,selectedInstallation:e}),this.props.onRunQuery())})))})),f(this,"addFilter",(()=>{const{onChange:e,query:t}=this.props;t.meta.push({key:"",value:""}),e(v(b({},t),{meta:t.meta}))})),f(this,"onMetaDelete",(e=>{const{onChange:t,query:n}=this.props;n.meta=n.meta.filter(((t,n)=>!(e===n))),t(v(b({},n),{meta:n.meta})),this.props.onRunQuery()})),f(this,"onMetaUpdate",((e,t,n)=>{const{onChange:a,query:o}=this.props;o.meta[e].key=t,o.meta[e].value=n,a(v(b({},o),{meta:o.meta})),this.onRunQuery()})),f(this,"onMessageChange",(e=>{const{onChange:t,query:n}=this.props;t(v(b({},n),{messageFrom:e.target.value})),this.onRunQuery()})),f(this,"onGroupByChange",(e=>{const{onChange:t,query:n}=this.props;t(v(b({},n),{groupBy:e.target.value})),this.onRunQuery()})),f(this,"onNameByChange",(e=>{const{onChange:t,query:n}=this.props;t(v(b({},n),{nameBy:e.target.value})),this.onRunQuery()})),f(this,"onLinkChange",(e=>{const{onChange:t,query:n}=this.props;t(v(b({},n),{linkKey:e.target.value})),this.onRunQuery()})),f(this,"onStateOnlyChange",(()=>{const{onChange:e,query:t}=this.props;e(v(b({},t),{stateOnly:!t.stateOnly})),this.props.onRunQuery()})),f(this,"onDatatable",(()=>{const{onChange:e,query:t}=this.props;e(v(b({},t),{tabledata:!t.tabledata})),this.props.onRunQuery()})),f(this,"onMetaAsFields",(()=>{const{onChange:e,query:t}=this.props;e(v(b({},t),{metaAsFields:!t.metaAsFields})),this.props.onRunQuery()})),f(this,"onDeviceMetaJoin",(()=>{const{onChange:e,query:t}=this.props;e(v(b({},t),{joinDeviceMeta:!t.joinDeviceMeta})),this.props.onRunQuery()})),f(this,"tooltipGroupBy",l().createElement(l().Fragment,null,"Group series by some meta key or payload ",l().createElement("code",null,"msg")," field. Defaults to Function ID.")),f(this,"tooltipNameBy",l().createElement(l().Fragment,null,"This will name series based on some meta key.",l().createElement("br",null),"Defaults to ",l().createElement("code",null,"name"),".")),f(this,"tooltipMessageFrom",l().createElement(l().Fragment,null,"Using this field will join matching functions with the same filter, but the type changed to this field. The msg field will be overwritten by messages matching this type, linked through ",l().createElement("code",null,"device_id")," meta key. Useful for eg. joining positional data. ",l().createElement("br",null),"This field is only applied on table data.")),this.state={installations:[],functions:[],selectedInstallation:{value:{id:0,name:"",client_id:0}},ticker:null,loadingInstallations:!0}}}const E=new(r(305).DataSourcePlugin)(o).setConfigEditor(m).setQueryEditor(j)})(),i})()));
//# sourceMappingURL=module.js.map