/* [create-plugin] version: 5.13.0 */
define(["@grafana/data","@grafana/runtime","@grafana/ui","lodash","module","react"],((e,t,n,a,r,l)=>(()=>{"use strict";var o={781:t=>{t.exports=e},531:e=>{e.exports=t},7:e=>{e.exports=n},241:e=>{e.exports=a},308:e=>{e.exports=r},959:e=>{e.exports=l}},i={};function c(e){var t=i[e];if(void 0!==t)return t.exports;var n=i[e]={exports:{}};return o[e](n,n.exports,c),n.exports}c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var n in t)c.o(t,n)&&!c.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},c.p="public/plugins/iotopen-datasource/";var u={};c.r(u),c.d(u,{plugin:()=>_});var s=c(308),m=c.n(s);c.p=m()&&m().uri?m().uri.slice(0,m().uri.lastIndexOf("/")+1):"public/plugins/iotopen-datasource/";var p=c(531),b=c(241);function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){d(e,t,n[t])}))}return e}function f(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}class g extends p.DataSourceWithBackend{fetchInstallations(){return(0,p.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/installationinfo`}).then((e=>e.data))}fetchFunctions(e,t){const n=t?Object.keys(t).map((e=>`${encodeURIComponent(e)}=${encodeURIComponent(t[e])}`)).join("&"):"";return(0,p.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/functionx/${e}?${n}`}).then((e=>e.data))}query(e){const t=(0,p.getTemplateSrv)(),n=e.targets.map((e=>f(y({},e),{installationId:e.installationVariable?(0,b.toNumber)(t.replace(e.installationVariable)):e.installationId,meta:e.meta.map((e=>({key:t.replace(e.key),value:t.replace(e.value)})),e)})));return super.query(f(y({},e),{targets:n}))}findMetaQuery(e,t){if(""===e.metaKey||"0"===e.installationId||""===e.installationId)return Promise.resolve([]);let n=(0,b.toNumber)(e.installationId);if("string"==typeof e.installationId&&e.installationId.includes("$")){const t=(0,p.getTemplateSrv)().replace(e.installationId);n=(0,b.toNumber)(t)}if(isNaN(n))return Promise.reject(`Invalid installation id: ${e.installationId} => ${n}`);const a=e.meta?e.meta.reduce(((e,t)=>(""!==t.key&&""!==t.value&&(e[t.key]=t.value),e)),{}):{};return this.fetchFunctions(n,a).then((t=>t.reduce(((t,n)=>!t.find((t=>t.text===n.meta[e.metaKey]))&&n.meta[e.metaKey]?[...t,{text:n.meta[e.metaKey],value:n.meta[e.metaKey]}]:t),[]))).then((e=>e))}metricFindQuery(e,t){return"installation"===(e.queryMode?e.queryMode:"functionMeta")?this.fetchInstallations().then((e=>e.reduce(((e,t)=>[...e,{text:t.name,value:t.id}]),[]))):this.findMetaQuery(e,t)}constructor(e){super(e),d(this,"settings",void 0),this.settings=e}}var v=c(959),h=c.n(v),O=c(7);const j=({type:e,tooltip:t,label:n,placeholder:a,name:r,value:l,onChange:o,labelWidth:i="auto",width:c})=>h().createElement(O.InlineField,{label:n,labelWidth:i,tooltip:t,grow:!0},h().createElement(O.Input,{type:e,name:r,placeholder:a,value:l,onChange:o,width:c})),w=({label:e,value:t,name:n,onChange:a,labelWidth:r="auto"})=>h().createElement(O.InlineFieldRow,null,h().createElement(O.InlineField,{label:e,labelWidth:r},h().createElement(O.InlineSwitch,{value:t,name:n,onChange:a})));function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){P(e,t,n[t])}))}return e}function k(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const D={installationId:0,type:"",meta:[{key:"type",value:""}]},S=({isLoading:e,installations:t,installation:n,onSelection:a})=>{const r=(0,v.useMemo)((()=>t.map((e=>({label:e.name,value:e})))),[t]),l=(0,v.useMemo)((()=>({label:n.name,value:n})),[n]),o=(0,v.useCallback)(((e,t)=>{var n,a;const r=t.toLowerCase();var l;return null!==(l=null===(a=e.value)||void 0===a||null===(n=a.name)||void 0===n?void 0:n.toLowerCase().includes(r))&&void 0!==l&&l}),[]);return h().createElement("div",{className:"gf-form-inline"},h().createElement(O.Select,{isLoading:e,placeholder:"Installation",noOptionsMessage:"No available installations",filterOption:o,width:65,options:r,menuPlacement:"bottom",onChange:e=>{var n;a(null!==(n=e.value)&&void 0!==n?n:t[0])},value:l}))};function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function I(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){C(e,t,n[t])}))}return e}function M(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const T=({data:e,keys:t,values:n,onUpdate:a,onDelete:r})=>{const l=(0,v.useMemo)((()=>t?t.map((e=>({label:e,value:e}))):[]),[t]),o=(0,v.useMemo)((()=>n?n.map((e=>({label:e,value:e}))):[]),[n]),i=(0,v.useMemo)((()=>({label:e.key,value:e.key})),[e]),c=(0,v.useMemo)((()=>({label:e.value,value:e.value})),[e]),u=(0,v.useCallback)((t=>{a(M(I({},e),{key:t.value}))}),[e,a]),s=(0,v.useCallback)((t=>{a(M(I({},e),{value:t.value}))}),[e,a]),m=(0,v.useCallback)((t=>{a(M(I({},e),{key:t}))}),[e,a]),p=(0,v.useCallback)((t=>{a(M(I({},e),{value:t}))}),[e,a]),b=(0,v.useCallback)((e=>{e.preventDefault(),r()}),[r]);return h().createElement("div",{className:"gf-form-inline"},h().createElement("div",{className:"gf-form"},h().createElement("span",{className:"gf-form-label query-keyword"},"key"),h().createElement(O.Select,{width:30,options:l,onChange:u,onCreateOption:m,value:i,isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"meta key"}),h().createElement("span",{className:"gf-form-label query-keyword"},"match"),h().createElement(O.Select,{width:30,options:o,onChange:s,onCreateOption:p,value:c,isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"wildcard match"}),h().createElement(O.Button,{variant:"destructive",onClick:b,icon:"trash-alt"})))},x=({entries:e,onUpdate:t,hints:n})=>{const a=(0,v.useCallback)((n=>{const a=e.filter(((e,t)=>t!==n));t(a)}),[e,t]),r=(0,v.useCallback)((n=>{t([...e,{key:"",value:""}]),n.preventDefault()}),[e,t]),l=(0,v.useCallback)(((n,a)=>{const r=e.map(((e,t)=>t===n?a:e));t(r)}),[e,t]);return h().createElement(O.VerticalGroup,null,h().createElement("div",{className:"gf-form-inline,ui-list"},e.map(((e,t)=>{var r;return h().createElement(T,{key:t,data:e,onDelete:()=>{a(t)},onUpdate:e=>l(t,e),keys:n?Object.keys(n):[],values:n&&null!==(r=n[e.key])&&void 0!==r?r:[]})}))),h().createElement("div",{className:"gf-form-inline",style:{paddingBottom:10}},h().createElement(O.Button,{onClick:r,icon:"plus"},"Add filter")))};function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function K(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){F(e,t,n[t])}))}return e}function W(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const N=h().createElement(h().Fragment,null,"Group series by some meta key or payload ",h().createElement("code",null,"msg")," field. Defaults to Function ID."),V=h().createElement(h().Fragment,null,"This will name series based on some meta key.",h().createElement("br",null),"Defaults to ",h().createElement("code",null,"name"),"."),q=h().createElement(h().Fragment,null,"Using this field will join matching functions with the same filter, but the type changed to this field. The msg field will be overwritten by messages matching this type, linked through ",h().createElement("code",null,"device_id")," meta key. Useful for eg. joining positional data. ",h().createElement("br",null),"This field is only applied on table data."),G=({query:e,onChange:t,onRunQuery:n})=>{const a=a=>{t(W(K({},e),{[a.currentTarget.name]:a.currentTarget.checked})),n()};return h().createElement(h().Fragment,null,h().createElement(O.VerticalGroup,{spacing:"xs"},h().createElement(j,{name:"groupBy",labelWidth:16,label:"Group by",onChange:a=>{t(W(K({},e),{groupBy:a.currentTarget.value})),n()},value:e.groupBy,placeholder:"Function ID",tooltip:N}),h().createElement(j,{name:"nameBy",labelWidth:16,label:"Name by",placeholder:"name",onChange:a=>{t(W(K({},e),{nameBy:a.currentTarget.value})),n()},value:e.nameBy,tooltip:V}),h().createElement(O.HorizontalGroup,{align:"flex-start",spacing:"xs"},h().createElement(w,{label:"As table data",value:e.tabledata,name:"tabledata",onChange:a,labelWidth:16}),e.tabledata&&h().createElement(O.VerticalGroup,{spacing:"xs",align:"flex-start"},h().createElement(j,{placeholder:"eg. latitude",name:"messageFrom",labelWidth:20,label:"Message from",onChange:a=>{t(W(K({},e),{messageFrom:a.currentTarget.value})),n()},value:e.messageFrom,tooltip:q}),h().createElement(j,{labelWidth:20,placeholder:"device_id",name:"linkKey",label:"Linked with",onChange:a=>{t(W(K({},e),{linkKey:a.currentTarget.value})),n()},value:e.linkKey}),h().createElement(w,{label:"Meta as fields",labelWidth:20,value:e.metaAsFields,name:"metaAsFields",onChange:a}),e.metaAsFields&&h().createElement(w,{label:"Add device meta",labelWidth:20,name:"joinDeviceMeta",value:e.joinDeviceMeta,onChange:a}))),h().createElement(w,{label:"Current state only",value:e.stateOnly,name:"stateOnly",onChange:a,labelWidth:16}),h().createElement(w,{label:"Meta as labels",name:"metaAsLabels",value:e.metaAsLabels,onChange:a=>{t(W(K({},e),{[a.currentTarget.name]:a.currentTarget.checked})),n()},labelWidth:16})))},A=({value:e,onSelection:t})=>{const n=(0,p.getTemplateSrv)().getVariables().map((e=>({label:e.name,value:`\${${e.name}}`})));return h().createElement("div",{className:"gf-form-inline"},h().createElement(O.Select,{placeholder:"Variable",noOptionsMessage:"No available variables",width:65,options:n,menuPlacement:"bottom",onChange:e=>{var n;return t(null!==(n=e.value)&&void 0!==n?n:"")},value:e}))};function R(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function B(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){R(e,t,n[t])}))}return e}function U(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function $(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function L(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){$(e,t,n[t])}))}return e}function Q(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const _=new(c(781).DataSourcePlugin)(g).setConfigEditor((({onOptionsChange:e,options:t})=>{const{jsonData:n,secureJsonData:a,secureJsonFields:r}=t,[l,o]=h().useState(!1);var i;return(0,v.useEffect)((()=>{if(void 0!==t.jsonData.apiKey&&""!==t.jsonData.apiKey){o(!0);let r=E({},n);delete r.apiKey,e(k(E({},t),{secureJsonData:k(E({},a),{apiKey:t.jsonData.apiKey}),jsonData:r}))}}),[]),h().createElement(O.VerticalGroup,{spacing:"none"},h().createElement(j,{label:"URL",value:t.jsonData.url||"",name:"url",placeholder:"Enter URL, eg. https://lynx.iotopen.se",onChange:a=>{e(k(E({},t),{jsonData:k(E({},n),{[a.target.name]:a.target.value})}))},labelWidth:15,width:40}),h().createElement(w,{labelWidth:15,label:"OAuth2 Passthru",name:"oauthPassThru",value:t.jsonData.oauthPassThru||!1,onChange:a=>{e(k(E({},t),{jsonData:k(E({},n),{[a.currentTarget.name]:a.currentTarget.checked})}))}}),!t.jsonData.oauthPassThru&&h().createElement(j,{label:"API Key",labelWidth:15,name:"apiKey",value:null!==(i=null==a?void 0:a.apiKey)&&void 0!==i?i:"",onChange:n=>{e(k(E({},t),{secureJsonData:k(E({},a),{[n.target.name]:n.target.value})}))},placeholder:r.apiKey?"Configured":"Enter API Key",width:70,type:"password"}),l&&!r.apiKey&&h().createElement(O.HorizontalGroup,{width:"100%"},h().createElement(O.Alert,{title:"Secure the API Key",severity:"error"},h().createElement(O.VerticalGroup,null,h().createElement("p",null,"The API key has migrated to a secure location. ",h().createElement("br",null),"Please press save to migrate the key to the secure store and get rid of this message.")))))})).setQueryEditor((({onChange:e,query:t,onRunQuery:n,datasource:a})=>{const[r,l]=(0,v.useState)([]),[o,i]=(0,v.useState)(!0),c=(0,v.useMemo)((()=>{let n=t;return void 0===n.installationId&&(n=B({},n,D),e(n)),n}),[t,e]),[u,s]=(0,v.useState)([]),[m,p]=(0,v.useState)(!1),[b,d]=(0,v.useState)({id:0,name:"",client_id:0}),y=((e,t)=>{const n=(0,v.useRef)();return(0,v.useCallback)((()=>{void 0!==n.current&&window.clearTimeout(n.current),n.current=window.setTimeout(e,t)}),[e,t])})(n,250);(0,v.useEffect)((()=>{a.fetchInstallations().then((e=>{let n=e.find((e=>e.id===t.installationId));void 0===n&&0===e.length&&(n={id:0,name:"No installations available",client_id:0}),void 0===n&&e.length>0&&(n=e[0]),d(n),l(e)})).finally((()=>{i(!1)}))}),[]),(0,v.useEffect)((()=>{0!==b.id&&(p(!0),a.fetchFunctions(Number(b.id)).then((e=>{s(e),y()})).finally((()=>{p(!1)})))}),[p,b,s,a,y]);const f=(0,v.useCallback)((t=>{e(U(B({},c),{meta:t})),y()}),[e,c,y]);(0,v.useEffect)((()=>{0!==b.id&&b.id!==c.installationId&&e(U(B({},c),{installationId:b.id}))}),[b,c,e]);const g=(0,v.useMemo)((()=>{const e={};for(const t of u){void 0===e.type?e.type=[t.type]:-1===e.type.indexOf(t.type)&&e.type.push(t.type);for(const n in t.meta)void 0===e[n]&&(e[n]=[]),-1===e[n].indexOf(t.meta[n])&&e[n].push(t.meta[n])}return e}),[u]),j=t=>{e(U(B({},c),{installationVariable:t}))};return h().createElement("div",{className:"section gf-form-group"},h().createElement(O.InlineFieldRow,null,void 0===c.installationVariable?h().createElement(S,{isLoading:o||m,installations:r,installation:b,onSelection:d}):h().createElement(A,{value:c.installationVariable,onSelection:j}),h().createElement(w,{label:"From variable",name:"useVariable",value:void 0!==c.installationVariable,onChange:e=>{e.currentTarget.checked?j(""):j(void 0)}})),h().createElement(x,{entries:c.meta||[],onUpdate:f,hints:g}),h().createElement(G,{query:t,onChange:e,onRunQuery:y}))})).setVariableQueryEditor((({query:e,onChange:t})=>{const n=(0,v.useMemo)((()=>void 0===e.queryMode||""===e.queryMode?Q(L({},e),{queryMode:"meta",installationId:"0",meta:[],metaKey:""}):e),[e]),a=e=>{t(Q(L({},n),{[e.target.name]:e.target.value}))};var r,l;return h().createElement(O.VerticalGroup,{spacing:"xs"},h().createElement(O.HorizontalGroup,{spacing:"xs"},h().createElement(O.InlineFieldRow,null,h().createElement(O.InlineField,{label:"Query mode",labelWidth:15},h().createElement(O.RadioButtonGroup,{options:[{label:"Meta values",value:"meta"},{label:"Installations",value:"installation"}],value:n.queryMode,onChange:e=>{t(Q(L({},n),{queryMode:null!=e?e:"meta"}))}})))),"meta"===n.queryMode&&h().createElement(O.VerticalGroup,null,h().createElement(O.HorizontalGroup,null,h().createElement(j,{label:"Installation ID",placeholder:"ID",value:void 0===n.installationId?"0":n.installationId.toString(),name:"installationId",onChange:a,labelWidth:15}),h().createElement(j,{label:"Meta key",placeholder:"name",labelWidth:15,value:null!==(r=e.metaKey)&&void 0!==r?r:"",name:"metaKey",onChange:a})),h().createElement(x,{entries:null!==(l=n.meta)&&void 0!==l?l:[],onUpdate:e=>{t(Q(L({},n),{meta:e}))}})))}));return u})()));
//# sourceMappingURL=module.js.map