define(["@grafana/runtime","react","@grafana/ui","@grafana/data"],((e,t,n,a)=>(()=>{"use strict";var o={305:e=>{e.exports=a},545:t=>{t.exports=e},388:e=>{e.exports=n},650:e=>{e.exports=t}},s={};function i(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return o[e](n,n.exports,i),n.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};return(()=>{i.r(r),i.d(r,{plugin:()=>O});var e=i(545);class t extends e.DataSourceWithBackend{fetchInstallations(){return(0,e.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/installationinfo`}).then((e=>e.data))}fetchFunctions(t){return(0,e.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/functionx/${t}`}).then((e=>e.data))}testDatasource(){return new Promise(((t,n)=>{(0,e.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/installationinfo`}).then((e=>{t({status:"success",message:"All good!"})})).catch((e=>{n({status:"error",message:e.statusText})}))}))}constructor(e){var t,n;super(e),n=void 0,(t="settings")in this?Object.defineProperty(this,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[t]=n,this.settings=e}}var n=i(650),a=i.n(n),o=i(388);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){s(e,t,n[t])}))}return e}function u(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const{FormField:c}=o.LegacyForms;class h extends n.PureComponent{componentDidMount(){}render(){const{options:e}=this.props,{jsonData:t}=e;return a().createElement("div",{className:"gf-form-group"},a().createElement("div",{className:"gf-form"},a().createElement(c,{label:"URL",inputWidth:24,labelWidth:6,onChange:this.onURLChange,value:t.url||"",placeholder:"https://lynx.iotopen.se"})),a().createElement("div",{className:"gf-form"},a().createElement(c,{label:"API Key",inputWidth:24,labelWidth:6,onChange:this.onAPIKeyChange,value:t.apiKey||"",placeholder:"Your API key"})))}constructor(...e){super(...e),s(this,"onAPIKeyChange",(e=>{const{onOptionsChange:t,options:n}=this.props,a=u(l({},n.jsonData),{apiKey:e.target.value});t(u(l({},n),{jsonData:a}))})),s(this,"onURLChange",(e=>{const{onOptionsChange:t,options:n}=this.props,a=u(l({},n.jsonData),{url:e.target.value});t(u(l({},n),{jsonData:a}))}))}}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class d extends n.PureComponent{shouldComponentUpdate(e,t,n){return!0}render(){const e=[],t=[];if(this.props.keys)for(const t of this.props.keys)e.push({label:t,value:t});if(this.props.values)for(const e of this.props.values)t.push({label:e,value:e});return a().createElement("div",{className:"gf-form-inline"},a().createElement("div",{className:"gf-form"},a().createElement("span",{className:"gf-form-label query-keyword"},"key"),a().createElement(o.Select,{width:30,options:e,onChange:this.onChangeKey,onCreateOption:this.onChangeKey,value:{label:this.props.data.key,value:this.props.data.key},isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"meta key"}),a().createElement("span",{className:"gf-form-label query-keyword"},"match"),a().createElement(o.Select,{width:30,options:t,onChange:this.onChangeValue,onCreateOption:this.onChangeValue,value:{label:this.props.data.value,value:this.props.data.value},isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"wildcard match"}),a().createElement(o.Button,{variant:"destructive",onClick:this.onDelete},"X")))}constructor(e){super(e),p(this,"onChangeKey",(e=>{"string"==typeof e?this.props.onUpdate(this.props.idx,e,this.props.data.value):this.props.onUpdate(this.props.idx,e.label,this.props.data.value)})),p(this,"onChangeValue",(e=>{console.log(e),"string"==typeof e?this.props.onUpdate(this.props.idx,this.props.data.key,e):this.props.onUpdate(this.props.idx,this.props.data.key,e.value)})),p(this,"onDelete",(()=>{this.props.onDelete(this.props.idx)}))}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){m(e,t,n[t])}))}return e}function y(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const{FormField:f,Switch:b}=o.LegacyForms;class v extends n.PureComponent{componentDidMount(){this.props.datasource.fetchInstallations().then((e=>{let t={id:0,client_id:0,name:""};if(e.length>0&&(t=e[0]),0!==this.props.query.installationId){const n=e.find((e=>e.id===this.props.query.installationId));void 0!==n&&(t=n)}this.onSelectInstallation({value:t}),this.setState({installations:e,loadingInstallations:!1,selectedInstallation:{value:t}})}))}onRunQuery(){if(this.state.ticker){clearTimeout(this.state.ticker);const e=setTimeout((()=>{this.props.onRunQuery()}),250);this.setState({ticker:e})}else{const e=setTimeout((()=>{this.props.onRunQuery()}),250);this.setState({ticker:e})}}getInstallationOptionLabel(e){return null==e.value?"":e.value.name}getMetaKeys(){const e=["id","type"];for(const t of this.state.functions)for(const n in t.meta)-1===e.indexOf(n)&&e.push(n);return e}getMetaValues(e){const t=[];for(const n of this.state.functions){let a=n.meta[e];"type"===e&&(a=n.type),"id"===e&&(a=n.id.toString()),a&&-1===t.indexOf(a)&&t.push(a)}return t}render(){const e=this.props.query;return null==e.meta&&(e.installationId=0,e.clientId=0,e.meta=[{key:"type",value:""}]),a().createElement("div",{className:"section gf-form-group"},a().createElement("div",{className:"gf-form-inline"},a().createElement(o.Select,{isLoading:this.state.loadingInstallations,width:65,getOptionLabel:this.getInstallationOptionLabel,options:this.state.installations.map((e=>({value:e}))),menuPlacement:"bottom",onChange:this.onSelectInstallation,value:this.state.selectedInstallation})),a().createElement("div",{className:"gf-form-inline,ui-list"},e.meta.map(((e,t)=>a().createElement(d,{key:t,idx:t,data:e,onDelete:this.onMetaDelete,onUpdate:this.onMetaUpdate,keys:this.getMetaKeys(),values:this.getMetaValues(e.key)})))),a().createElement("div",{className:"gf-form-inline",style:{paddingBottom:10}},a().createElement(o.Button,{onClick:this.addFilter},"Add filter")),a().createElement("div",{className:"gf-form-inline"},a().createElement(f,{labelWidth:40,label:"Group by",onChange:this.onGroupByChange,value:e.groupBy,tooltip:this.tooltipGroupBy}),a().createElement(f,{labelWidth:40,label:"Name by",onChange:this.onNameByChange,value:e.nameBy,tooltip:this.tooltipNameBy})),a().createElement("div",{className:"gf-form-inline"},a().createElement(b,{label:"As table data",checked:e.tabledata,onChange:this.onDatatable}),a().createElement("div",{hidden:!e.tabledata},a().createElement(f,{labelWidth:40,label:"Message from",onChange:this.onMessageChange,value:e.messageFrom,tooltip:this.tooltipMessageFrom}),a().createElement(f,{labelWidth:40,label:"Linked with",onChange:this.onLinkChange,value:e.linkKey}),a().createElement("div",null,a().createElement(b,{label:"Meta to fields",checked:e.metaAsFields,onChange:this.onMetaAsFields}),a().createElement("div",{hidden:!e.metaAsFields},a().createElement(b,{label:"Add device meta",checked:e.joinDeviceMeta,onChange:this.onDeviceMetaJoin}))))),a().createElement(b,{label:"Current state only",checked:e.stateOnly,onChange:this.onStateOnlyChange}))}constructor(e){super(e),m(this,"onSelectInstallation",(e=>{const{onChange:t,query:n}=this.props;null!=e.value&&(this.setState({selectedInstallation:e}),t(y(g({},n),{installationId:e.value.id,clientId:e.value.client_id})),this.props.datasource.fetchFunctions(Number(e.value.id)).then((t=>{void 0!==e.value&&this.state.selectedInstallation.value===e.value&&(this.setState({functions:t,selectedInstallation:e}),this.props.onRunQuery())})))})),m(this,"addFilter",(()=>{const{onChange:e,query:t}=this.props;t.meta.push({key:"",value:""}),e(y(g({},t),{meta:t.meta}))})),m(this,"onMetaDelete",(e=>{const{onChange:t,query:n}=this.props;n.meta=n.meta.filter(((t,n)=>!(e===n))),t(y(g({},n),{meta:n.meta})),this.props.onRunQuery()})),m(this,"onMetaUpdate",((e,t,n)=>{const{onChange:a,query:o}=this.props;o.meta[e].key=t,o.meta[e].value=n,a(y(g({},o),{meta:o.meta})),this.onRunQuery()})),m(this,"onMessageChange",(e=>{const{onChange:t,query:n}=this.props;t(y(g({},n),{messageFrom:e.target.value})),this.onRunQuery()})),m(this,"onGroupByChange",(e=>{const{onChange:t,query:n}=this.props;t(y(g({},n),{groupBy:e.target.value})),this.onRunQuery()})),m(this,"onNameByChange",(e=>{const{onChange:t,query:n}=this.props;t(y(g({},n),{nameBy:e.target.value})),this.onRunQuery()})),m(this,"onLinkChange",(e=>{const{onChange:t,query:n}=this.props;t(y(g({},n),{linkKey:e.target.value})),this.onRunQuery()})),m(this,"onStateOnlyChange",(()=>{const{onChange:e,query:t}=this.props;e(y(g({},t),{stateOnly:!t.stateOnly})),this.props.onRunQuery()})),m(this,"onDatatable",(()=>{const{onChange:e,query:t}=this.props;e(y(g({},t),{tabledata:!t.tabledata})),this.props.onRunQuery()})),m(this,"onMetaAsFields",(()=>{const{onChange:e,query:t}=this.props;e(y(g({},t),{metaAsFields:!t.metaAsFields})),this.props.onRunQuery()})),m(this,"onDeviceMetaJoin",(()=>{const{onChange:e,query:t}=this.props;e(y(g({},t),{joinDeviceMeta:!t.joinDeviceMeta})),this.props.onRunQuery()})),m(this,"tooltipGroupBy",a().createElement(a().Fragment,null,"Group series by some meta key or payload ",a().createElement("code",null,"msg")," field. Defaults to Function ID.")),m(this,"tooltipNameBy",a().createElement(a().Fragment,null,"This will name series based on some meta key.",a().createElement("br",null),"Defaults to ",a().createElement("code",null,"name"),".")),m(this,"tooltipMessageFrom",a().createElement(a().Fragment,null,"Using this field will join matching functions with the same filter, but the type changed to this field. The msg field will be overwritten by messages matching this type, linked through ",a().createElement("code",null,"device_id")," meta key. Useful for eg. joining positional data. ",a().createElement("br",null),"This field is only applied on table data.")),this.state={installations:[],functions:[],selectedInstallation:{value:{id:0,name:"",client_id:0}},ticker:null,loadingInstallations:!0}}}const O=new(i(305).DataSourcePlugin)(t).setConfigEditor(h).setQueryEditor(v)})(),r})()));
//# sourceMappingURL=module.js.map