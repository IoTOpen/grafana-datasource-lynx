/*! For license information please see module.js.LICENSE.txt */
define(["react","@grafana/ui","@grafana/data"],(function(e,t,n){return function(e){var t={};function n(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};return e[a].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(a,o,function(t){return e[t]}.bind(null,o));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=3)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t,n){"use strict";n.r(t);var a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function o(e,t){function n(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var r=function(){return(r=Object.assign||function(e){for(var t,n=1,a=arguments.length;n<a;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function l(e,t,n,a){return new(n||(n=Promise))((function(o,r){function l(e){try{u(a.next(e))}catch(e){r(e)}}function i(e){try{u(a.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,i)}u((a=a.apply(e,t||[])).next())}))}function i(e,t){var n,a,o,r,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function i(r){return function(i){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;l;)try{if(n=1,a&&(o=2&r[0]?a.return:r[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,r[1])).done)return o;switch(a=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return l.label++,{value:r[1],done:!1};case 5:l.label++,a=r[1],r=[0];continue;case 7:r=l.ops.pop(),l.trys.pop();continue;default:if(!(o=l.trys,(o=o.length>0&&o[o.length-1])||6!==r[0]&&2!==r[0])){l=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){l.label=r[1];break}if(6===r[0]&&l.label<o[1]){l.label=o[1],o=r;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(r);break}o[2]&&l.ops.pop(),l.trys.pop();continue}r=t.call(e,l)}catch(e){r=[6,e],a=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,i])}}}function u(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],a=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&a>=e.length&&(e=void 0),{value:e&&e[a++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var s=n(2),c=function(e){function t(t,n){var a=e.call(this,t)||this;return a.backendSrv=n,a.settings=t,a}return o(t,e),t.prototype.backendAPIRequest=function(e,t,n){var a=e;a.from=t/1e3,a.to=n/1e3;var o=JSON.stringify(a);return this.backendSrv.post("/api/datasources/"+this.settings.id+"/resources/lynx-api",o).then((function(e){return e}))},t.prototype.fetchInstallations=function(){return this.backendSrv.datasourceRequest({method:"GET",url:this.settings.url+"/api/v2/installationinfo"}).then((function(e){return e.data}))},t.prototype.fetchFunctions=function(e){return this.backendSrv.datasourceRequest({method:"GET",url:this.settings.url+"/api/v2/functionx/"+e}).then((function(e){return e.data}))},t.prototype.query=function(e){return l(this,void 0,Promise,(function(){var t,n,a,o,r,l,c,p,f,d,h,y,m,v,g,b,C,k,E,w,S,x,O;return i(this,(function(i){switch(i.label){case 0:null==(t=e.range)&&(t=s.DefaultTimeRange),n=t.from.valueOf(),a=t.to.valueOf(),o=e.targets.filter((function(e){return!e.hide})),r={data:[]},l=[];try{for(c=u(o),p=c.next();!p.done;p=c.next())f=p.value,d=this.backendAPIRequest(f,n,a),l.push(d)}catch(e){k={error:e}}finally{try{p&&!p.done&&(E=c.return)&&E.call(c)}finally{if(k)throw k.error}}return[4,Promise.all(l)];case 1:h=i.sent();try{for(y=u(h),m=y.next();!m.done;m=y.next())if(null!==(v=m.value))try{for(x=void 0,g=u(v),b=g.next();!b.done;b=g.next())C=b.value,r.data.push(C)}catch(e){x={error:e}}finally{try{b&&!b.done&&(O=g.return)&&O.call(g)}finally{if(x)throw x.error}}}catch(e){w={error:e}}finally{try{m&&!m.done&&(S=y.return)&&S.call(y)}finally{if(w)throw w.error}}return[2,r]}}))}))},t.prototype.testDatasource=function(){var e=this;return new Promise((function(t,n){e.backendSrv.datasourceRequest({method:"GET",url:e.settings.url+"/api/v2/installationinfo"}).then((function(e){t({status:"success",message:"All good!"})})).catch((function(e){n({status:"error",message:e.statusText})}))}))},t}(s.DataSourceApi),p=n(0),f=n.n(p),d=n(1),h=d.LegacyForms.FormField,y=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onAPIKeyChange=function(e){var n=t.props,a=n.onOptionsChange,o=n.options,l=r(r({},o.jsonData),{apiKey:e.target.value});a(r(r({},o),{jsonData:l}))},t.onURLChange=function(e){var n=t.props,a=n.onOptionsChange,o=n.options,l=r(r({},o.jsonData),{url:e.target.value});a(r(r({},o),{jsonData:l}))},t}return o(t,e),t.prototype.componentDidMount=function(){},t.prototype.render=function(){var e=this.props.options.jsonData;return f.a.createElement("div",{className:"gf-form-group"},f.a.createElement("div",{className:"gf-form"},f.a.createElement(h,{label:"URL",inputWidth:24,labelWidth:6,onChange:this.onURLChange,value:e.url||"",placeholder:"https://aam.iotopen.se"})),f.a.createElement("div",{className:"gf-form"},f.a.createElement(h,{label:"API Key",inputWidth:24,labelWidth:6,onChange:this.onAPIKeyChange,value:e.apiKey||"",placeholder:"Your API key"})))},t}(p.PureComponent);function m(e){return(m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var v=function(e){function t(t){var n=e.call(this,t)||this;return n.onChangeKey=function(e){m(e)===m("")?n.props.onUpdate(n.props.idx,e,n.props.data.value):n.props.onUpdate(n.props.idx,e.label,n.props.data.value)},n.onChangeValue=function(e){console.log(e),m(e)===m("")?n.props.onUpdate(n.props.idx,n.props.data.key,e):n.props.onUpdate(n.props.idx,n.props.data.key,e.value)},n.onDelete=function(e){n.props.onDelete(n.props.idx)},n}return o(t,e),t.prototype.shouldComponentUpdate=function(e,t,n){return!0},t.prototype.render=function(){var e,t,n,a,o=[],r=[];if(this.props.keys)try{for(var l=u(this.props.keys),i=l.next();!i.done;i=l.next()){var s=i.value;o.push({label:s,value:s})}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=l.return)&&t.call(l)}finally{if(e)throw e.error}}if(this.props.values)try{for(var c=u(this.props.values),p=c.next();!p.done;p=c.next()){s=p.value;r.push({label:s,value:s})}}catch(e){n={error:e}}finally{try{p&&!p.done&&(a=c.return)&&a.call(c)}finally{if(n)throw n.error}}return f.a.createElement("div",{className:"gf-form-inline"},f.a.createElement("div",{className:"gf-form"},f.a.createElement("span",{className:"gf-form-label query-keyword"},"key"),f.a.createElement(d.Select,{width:30,options:o,onChange:this.onChangeKey,onCreateOption:this.onChangeKey,value:{label:this.props.data.key,value:this.props.data.key},isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"meta key"}),f.a.createElement("span",{className:"gf-form-label query-keyword"},"match"),f.a.createElement(d.Select,{width:30,options:r,onChange:this.onChangeValue,onCreateOption:this.onChangeValue,value:{label:this.props.data.value,value:this.props.data.value},isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"wildcard match"}),f.a.createElement(d.Button,{variant:"destructive",onClick:this.onDelete},"X")))},t}(p.PureComponent),g=d.LegacyForms.FormField,b=d.LegacyForms.Switch,C=function(e){function t(t){var n=e.call(this,t)||this;return n.onSelectInstallation=function(e){var t=n.props,a=t.onChange,o=t.query;null!=e.value&&(n.setState({selectedInstallation:e}),a(r(r({},o),{installationId:e.value.id,clientId:e.value.client_id})),n.props.datasource.fetchFunctions(Number(e.value.id)).then((function(t){void 0!==e.value&&n.state.selectedInstallation.value===e.value&&(n.setState({functions:t,selectedInstallation:e}),n.props.onRunQuery())})))},n.addFilter=function(){var e=n.props,t=e.onChange,a=e.query;a.meta.push({key:"",value:""}),t(r(r({},a),{meta:a.meta}))},n.onMetaDelete=function(e){var t=n.props,a=t.onChange,o=t.query;o.meta=o.meta.filter((function(t,n){return!(e===n)})),a(r(r({},o),{meta:o.meta})),n.props.onRunQuery()},n.onMetaUpdate=function(e,t,a){var o=n.props,l=o.onChange,i=o.query;i.meta[e].key=t,i.meta[e].value=a,l(r(r({},i),{meta:i.meta})),n.onRunQuery()},n.onMessageChange=function(e){var t=n.props,a=t.onChange,o=t.query;a(r(r({},o),{messageFrom:e.target.value})),n.onRunQuery()},n.onGroupByChange=function(e){var t=n.props,a=t.onChange,o=t.query;a(r(r({},o),{groupBy:e.target.value})),n.onRunQuery()},n.onNameByChange=function(e){var t=n.props,a=t.onChange,o=t.query;a(r(r({},o),{nameBy:e.target.value})),n.onRunQuery()},n.onLinkChange=function(e){var t=n.props,a=t.onChange,o=t.query;a(r(r({},o),{linkKey:e.target.value})),n.onRunQuery()},n.onStateOnlyChange=function(){var e=n.props,t=e.onChange,a=e.query;t(r(r({},a),{stateOnly:!a.stateOnly})),n.props.onRunQuery()},n.onDatatable=function(){var e=n.props,t=e.onChange,a=e.query;t(r(r({},a),{tabledata:!a.tabledata})),n.props.onRunQuery()},n.onMetaAsFields=function(){var e=n.props,t=e.onChange,a=e.query;t(r(r({},a),{metaAsFields:!a.metaAsFields})),n.props.onRunQuery()},n.onDeviceMetaJoin=function(){var e=n.props,t=e.onChange,a=e.query;t(r(r({},a),{joinDeviceMeta:!a.joinDeviceMeta})),n.props.onRunQuery()},n.tooltipGroupBy=f.a.createElement(f.a.Fragment,null,"Group series by some meta key or payload ",f.a.createElement("code",null,"msg")," field. Defaults to Function ID."),n.tooltipNameBy=f.a.createElement(f.a.Fragment,null,"This will name series based on some meta key.",f.a.createElement("br",null),"Defaults to ",f.a.createElement("code",null,"name"),"."),n.tooltipMessageFrom=f.a.createElement(f.a.Fragment,null,"Using this field will join matching functions with the same filter, but the type changed to this field. The msg field will be overwritten by messages matching this type, linked through ",f.a.createElement("code",null,"device_id")," meta key. Useful for eg. joining positional data. ",f.a.createElement("br",null),"This field is only applied on table data."),n.state={installations:[],functions:[],selectedInstallation:{value:{id:0,name:"",client_id:0}},ticker:null,loadingInstallations:!0},n}return o(t,e),t.prototype.componentDidMount=function(){var e=this;this.props.datasource.fetchInstallations().then((function(t){var n={id:0,client_id:0,name:""};if(t.length>0&&(n=t[0]),0!==e.props.query.installationId){var a=t.find((function(t){return t.id===e.props.query.installationId}));void 0!==a&&(n=a)}e.onSelectInstallation({value:n}),e.setState({installations:t,loadingInstallations:!1,selectedInstallation:{value:n}})}))},t.prototype.onRunQuery=function(){var e=this;if(this.state.ticker){clearTimeout(this.state.ticker);var t=setTimeout((function(){e.props.onRunQuery()}),250);this.setState({ticker:t})}else{t=setTimeout((function(){e.props.onRunQuery()}),250);this.setState({ticker:t})}},t.prototype.getInstallationOptionLabel=function(e){return null==e.value?"":e.value.name},t.prototype.getMetaKeys=function(){var e,t,n=["id","type"];try{for(var a=u(this.state.functions),o=a.next();!o.done;o=a.next()){var r=o.value;for(var l in r.meta)-1===n.indexOf(l)&&n.push(l)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}return n},t.prototype.getMetaValues=function(e){var t,n,a=[];try{for(var o=u(this.state.functions),r=o.next();!r.done;r=o.next()){var l=r.value,i=l.meta[e];"type"===e&&(i=l.type),"id"===e&&(i=l.id.toString()),i&&-1===a.indexOf(i)&&a.push(i)}}catch(e){t={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return a},t.prototype.render=function(){var e=this,t=this.props.query;return null==t.meta&&(t.installationId=0,t.clientId=0,t.meta=[{key:"type",value:""}]),f.a.createElement("div",{className:"section gf-form-group"},f.a.createElement("div",{className:"gf-form-inline"},f.a.createElement(d.Select,{isLoading:this.state.loadingInstallations,width:65,getOptionLabel:this.getInstallationOptionLabel,options:this.state.installations.map((function(e){return{value:e}})),menuPlacement:"bottom",onChange:this.onSelectInstallation,value:this.state.selectedInstallation})),f.a.createElement("div",{className:"gf-form-inline,ui-list"},t.meta.map((function(t,n){return f.a.createElement(v,{idx:n,data:t,onDelete:e.onMetaDelete,onUpdate:e.onMetaUpdate,keys:e.getMetaKeys(),values:e.getMetaValues(t.key)})}))),f.a.createElement("div",{className:"gf-form-inline",style:{paddingBottom:10}},f.a.createElement(d.Button,{onClick:this.addFilter},"Add filter")),f.a.createElement("div",{className:"gf-form-inline"},f.a.createElement(g,{labelWidth:40,label:"Group by",onChange:this.onGroupByChange,value:t.groupBy,tooltip:this.tooltipGroupBy}),f.a.createElement(g,{labelWidth:40,label:"Name by",onChange:this.onNameByChange,value:t.nameBy,tooltip:this.tooltipNameBy})),f.a.createElement("div",{className:"gf-form-inline"},f.a.createElement(b,{label:"As table data",checked:t.tabledata,onChange:this.onDatatable}),f.a.createElement("div",{hidden:!t.tabledata},f.a.createElement(g,{labelWidth:40,label:"Message from",onChange:this.onMessageChange,value:t.messageFrom,tooltip:this.tooltipMessageFrom}),f.a.createElement(g,{labelWidth:40,label:"Linked with",onChange:this.onLinkChange,value:t.linkKey}),f.a.createElement("div",null,f.a.createElement(b,{label:"Meta to fields",checked:t.metaAsFields,onChange:this.onMetaAsFields}),f.a.createElement("div",{hidden:!t.metaAsFields},f.a.createElement(b,{label:"Add device meta",checked:t.joinDeviceMeta,onChange:this.onDeviceMetaJoin}))))),f.a.createElement(b,{label:"Current state only",checked:t.stateOnly,onChange:this.onStateOnlyChange}))},t}(p.PureComponent);n.d(t,"plugin",(function(){return k}));var k=new s.DataSourcePlugin(c).setConfigEditor(y).setQueryEditor(C)}])}));
//# sourceMappingURL=module.js.map