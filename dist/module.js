define(["@grafana/runtime","react","@grafana/ui","@grafana/data"],((e,t,n,a)=>(()=>{"use strict";var r={305:e=>{e.exports=a},545:t=>{t.exports=e},388:e=>{e.exports=n},650:e=>{e.exports=t}},l={};function o(e){var t=l[e];if(void 0!==t)return t.exports;var n=l[e]={exports:{}};return r[e](n,n.exports,o),n.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{o.r(i),o.d(i,{plugin:()=>W});var e=o(545);function t(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function n(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{},r=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),r.forEach((function(n){t(e,n,a[n])}))}return e}function a(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}class r extends e.DataSourceWithBackend{fetchInstallations(){return(0,e.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/installationinfo`}).then((e=>e.data))}fetchFunctions(t,n){const a=n?Object.keys(n).map((e=>`${encodeURIComponent(e)}=${encodeURIComponent(n[e])}`)).join("&"):"";return(0,e.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/functionx/${t}?${a}`}).then((e=>e.data))}query(t){const r=(0,e.getTemplateSrv)(),l=t.targets.map((e=>a(n({},e),{meta:e.meta.map((e=>({key:r.replace(e.key),value:r.replace(e.value)})))})));return super.query(a(n({},t),{targets:l}))}metricFindQuery(e,t){if(""===e.metaKey||0===e.installationId)return Promise.resolve([]);const n=e.meta?e.meta.reduce(((e,t)=>(""!==t.key&&""!==t.value&&(e[t.key]=t.value),e)),{}):{};return this.fetchFunctions(e.installationId,n).then((t=>t.reduce(((t,n)=>!t.find((t=>t.text===n.meta[e.metaKey]))&&n.meta[e.metaKey]?[...t,{text:n.meta[e.metaKey],value:n.meta[e.metaKey]}]:t),[]))).then((e=>e))}constructor(e){super(e),t(this,"settings",void 0),this.settings=e}}var l=o(650),c=o.n(l),u=o(388);const s=({type:e,tooltip:t,label:n,placeholder:a,name:r,value:l,onChange:o,labelWidth:i="auto",width:s})=>c().createElement(u.InlineField,{label:n,labelWidth:i,tooltip:t,grow:!0},c().createElement(u.Input,{type:e,name:r,placeholder:a,value:l,onChange:o,width:s})),m=({label:e,value:t,name:n,onChange:a,labelWidth:r="auto"})=>c().createElement(u.InlineFieldRow,null,c().createElement(u.InlineField,{label:e,labelWidth:r},c().createElement(u.InlineSwitch,{value:t,name:n,onChange:a})));function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function b(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){p(e,t,n[t])}))}return e}function d(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const y={installationId:0,clientId:0,type:"",meta:[{key:"type",value:""}]},f=({isLoading:e,installations:t,installation:n,onSelection:a})=>{const r=(0,l.useMemo)((()=>t.map((e=>({label:e.name,value:e})))),[t]),o=(0,l.useMemo)((()=>({label:n.name,value:n})),[n]),i=(0,l.useCallback)(((e,t)=>{var n,a;const r=t.toLowerCase();var l;return null!==(l=null===(a=e.value)||void 0===a||null===(n=a.name)||void 0===n?void 0:n.toLowerCase().includes(r))&&void 0!==l&&l}),[]);return c().createElement("div",{className:"gf-form-inline"},c().createElement(u.Select,{isLoading:e,placeholder:"Installation",noOptionsMessage:"No available installations",filterOption:i,width:65,options:r,menuPlacement:"bottom",onChange:e=>{var n;a(null!==(n=e.value)&&void 0!==n?n:t[0])},value:o}))};function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){g(e,t,n[t])}))}return e}function O(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const v=({data:e,keys:t,values:n,onUpdate:a,onDelete:r})=>{const o=(0,l.useMemo)((()=>t?t.map((e=>({label:e,value:e}))):[]),[t]),i=(0,l.useMemo)((()=>n?n.map((e=>({label:e,value:e}))):[]),[n]),s=(0,l.useMemo)((()=>({label:e.key,value:e.key})),[e]),m=(0,l.useMemo)((()=>({label:e.value,value:e.value})),[e]),p=(0,l.useCallback)((t=>{a(O(h({},e),{key:t.value}))}),[e,a]),b=(0,l.useCallback)((t=>{a(O(h({},e),{value:t.value}))}),[e,a]),d=(0,l.useCallback)((t=>{a(O(h({},e),{key:t}))}),[e,a]),y=(0,l.useCallback)((t=>{a(O(h({},e),{value:t}))}),[e,a]);return c().createElement("div",{className:"gf-form-inline"},c().createElement("div",{className:"gf-form"},c().createElement("span",{className:"gf-form-label query-keyword"},"key"),c().createElement(u.Select,{width:30,options:o,onChange:p,onCreateOption:d,value:s,isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"meta key"}),c().createElement("span",{className:"gf-form-label query-keyword"},"match"),c().createElement(u.Select,{width:30,options:i,onChange:b,onCreateOption:y,value:m,isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"wildcard match"}),c().createElement(u.Button,{variant:"destructive",onClick:r,icon:"trash-alt"})))},j=({entries:e,onUpdate:t,hints:n})=>{const a=(0,l.useCallback)((n=>{const a=e.filter(((e,t)=>t!==n));t(a)}),[e,t]),r=(0,l.useCallback)((()=>{t([...e,{key:"",value:""}])}),[e,t]),o=(0,l.useCallback)(((n,a)=>{const r=e.map(((e,t)=>t===n?a:e));t(r)}),[e,t]);return c().createElement(u.VerticalGroup,null,c().createElement("div",{className:"gf-form-inline,ui-list"},e.map(((e,t)=>{var r;return c().createElement(v,{key:t,data:e,onDelete:()=>a(t),onUpdate:e=>o(t,e),keys:n?Object.keys(n):[],values:n&&null!==(r=n[e.key])&&void 0!==r?r:[]})}))),c().createElement("div",{className:"gf-form-inline",style:{paddingBottom:10}},c().createElement(u.Button,{onClick:r,icon:"plus"},"Add filter")))};function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function P(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){w(e,t,n[t])}))}return e}function E(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const k=c().createElement(c().Fragment,null,"Group series by some meta key or payload ",c().createElement("code",null,"msg")," field. Defaults to Function ID."),S=c().createElement(c().Fragment,null,"This will name series based on some meta key.",c().createElement("br",null),"Defaults to ",c().createElement("code",null,"name"),"."),D=c().createElement(c().Fragment,null,"Using this field will join matching functions with the same filter, but the type changed to this field. The msg field will be overwritten by messages matching this type, linked through ",c().createElement("code",null,"device_id")," meta key. Useful for eg. joining positional data. ",c().createElement("br",null),"This field is only applied on table data."),C=({query:e,onChange:t,onRunQuery:n})=>{const a=a=>{t(E(P({},e),{[a.currentTarget.name]:a.currentTarget.checked})),n()};return c().createElement(c().Fragment,null,c().createElement(u.VerticalGroup,{spacing:"xs"},c().createElement(s,{name:"groupBy",labelWidth:15,label:"Group by",onChange:a=>{t(E(P({},e),{groupBy:a.currentTarget.value})),n()},value:e.groupBy,placeholder:"Function ID",tooltip:k}),c().createElement(s,{name:"nameBy",labelWidth:15,label:"Name by",placeholder:"name",onChange:a=>{t(E(P({},e),{nameBy:a.currentTarget.value})),n()},value:e.nameBy,tooltip:S}),c().createElement(u.HorizontalGroup,{align:"flex-start",spacing:"xs"},c().createElement(m,{label:"As table data",value:e.tabledata,name:"tabledata",onChange:a,labelWidth:15}),e.tabledata&&c().createElement(u.VerticalGroup,{spacing:"xs",align:"flex-start"},c().createElement(s,{placeholder:"eg. latitude",name:"messageFrom",labelWidth:20,label:"Message from",onChange:a=>{t(E(P({},e),{messageFrom:a.currentTarget.value})),n()},value:e.messageFrom,tooltip:D}),c().createElement(s,{labelWidth:20,placeholder:"device_id",name:"linkKey",label:"Linked with",onChange:a=>{t(E(P({},e),{linkKey:a.currentTarget.value})),n()},value:e.linkKey}),c().createElement(m,{label:"Meta as fields",labelWidth:20,value:e.metaAsFields,name:"metaAsFields",onChange:a}),e.metaAsFields&&c().createElement(m,{label:"Add device meta",labelWidth:20,name:"joinDeviceMeta",value:e.joinDeviceMeta,onChange:a}))),c().createElement(m,{label:"Current state only",value:e.stateOnly,name:"stateOnly",onChange:a})))};function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function K(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){I(e,t,n[t])}))}return e}function T(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function F(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){x(e,t,n[t])}))}return e}function M(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const W=new(o(305).DataSourcePlugin)(r).setConfigEditor((({onOptionsChange:e,options:t})=>{var n;const{jsonData:a,secureJsonData:r,secureJsonFields:o}=t,[i,p]=c().useState(!1);var y;return(0,l.useEffect)((()=>{if(void 0!==t.jsonData.apiKey&&""!==t.jsonData.apiKey){p(!0);let n=b({},a);delete n.apiKey,e(d(b({},t),{secureJsonData:d(b({},r),{apiKey:t.jsonData.apiKey}),jsonData:n}))}}),[]),c().createElement(u.VerticalGroup,{spacing:"none"},c().createElement(s,{label:"URL",value:t.jsonData.url||"",name:"url",placeholder:"https://lynx.iotopen.se",onChange:n=>{e(d(b({},t),{jsonData:d(b({},a),{[n.target.name]:n.target.value})}))},labelWidth:15,width:40}),c().createElement(m,{labelWidth:15,label:"OAuth2 Passthru",name:"oauthPassThru",value:t.jsonData.oauthPassThru||!1,onChange:n=>{e(d(b({},t),{jsonData:d(b({},a),{[n.currentTarget.name]:n.currentTarget.checked})}))}}),!t.jsonData.oauthPassThru&&c().createElement(s,{label:"API Key",labelWidth:15,name:"apiKey",value:null!==(y=null===(n=r)||void 0===n?void 0:n.apiKey)&&void 0!==y?y:"",onChange:n=>{e(d(b({},t),{secureJsonData:d(b({},r),{[n.target.name]:n.target.value})}))},placeholder:o.apiKey?"Configured":"Enter API Key",width:70,type:"password"}),i&&!o.apiKey&&c().createElement(u.HorizontalGroup,{width:"100%"},c().createElement(u.Alert,{title:"Secure the API Key",severity:"error"},c().createElement(u.VerticalGroup,null,c().createElement("p",null,"The API key has migrated to a secure location. ",c().createElement("br",null),"Please press save to migrate the key to the secure store and get rid of this message.")))))})).setQueryEditor((({onChange:e,query:t,onRunQuery:n,datasource:a})=>{const[r,o]=(0,l.useState)([]),[i,u]=(0,l.useState)(!0),s=(0,l.useMemo)((()=>{let n=t;return void 0===n.installationId&&(n=K({},n,y),e(n)),n}),[t,e]),[m,p]=(0,l.useState)([]),[b,d]=(0,l.useState)(!1),[g,h]=(0,l.useState)({id:0,name:"",client_id:0}),O=((e,t)=>{const n=(0,l.useRef)();return(0,l.useCallback)((()=>{void 0!==n.current&&window.clearTimeout(n.current),n.current=window.setTimeout(e,250)}),[e,250])})(n);(0,l.useEffect)((()=>{a.fetchInstallations().then((e=>{let n=e.find((e=>e.id===t.installationId));void 0===n&&0===e.length&&(n={id:0,name:"No installations available",client_id:0}),void 0===n&&e.length>0&&(n=e[0]),h(n),o(e)})).finally((()=>{u(!1)}))}),[]),(0,l.useEffect)((()=>{0!==g.id&&(d(!0),a.fetchFunctions(Number(g.id)).then((e=>{p(e),O()})).finally((()=>{d(!1)})))}),[d,g,p,a,O]);const v=(0,l.useCallback)((t=>{e(T(K({},s),{meta:t})),O()}),[e,s,O]);(0,l.useEffect)((()=>{0!==g.id&&g.id!==s.installationId&&g.client_id!==s.clientId&&e(T(K({},s),{installationId:g.id,clientId:g.client_id}))}),[g,s,e]);const w=(0,l.useMemo)((()=>{const e={};for(const t of m){void 0===e.type?e.type=[t.type]:-1===e.type.indexOf(t.type)&&e.type.push(t.type);for(const n in t.meta)void 0===e[n]&&(e[n]=[]),-1===e[n].indexOf(t.meta[n])&&e[n].push(t.meta[n])}return e}),[m]);return c().createElement("div",{className:"section gf-form-group"},c().createElement(f,{isLoading:i||b,installations:r,installation:g,onSelection:h}),c().createElement(j,{entries:s.meta||[],onUpdate:v,hints:w}),c().createElement(C,{query:t,onChange:e,onRunQuery:O}))})).setVariableQueryEditor((({query:e,onChange:t})=>{var n,a,r,o;return(0,l.useEffect)((()=>{let n=e;void 0===n.installationId&&(n=M(F({},n),{installationId:0,meta:[],metaKey:""}),t(n))}),[]),c().createElement(u.VerticalGroup,{spacing:"none"},c().createElement(u.HorizontalGroup,null,c().createElement(s,{label:"Installation ID",placeholder:"ID",value:null!==(a=null===(n=e.installationId)||void 0===n?void 0:n.toString())&&void 0!==a?a:0,name:"installationId",onChange:n=>{const a=parseInt(n.target.value,10);isNaN(a)?t(M(F({},e),{[n.target.name]:0})):t(M(F({},e),{[n.target.name]:a}))},labelWidth:15})),c().createElement(u.HorizontalGroup,null,c().createElement(s,{label:"Meta key",placeholder:"name",labelWidth:15,value:null!==(r=e.metaKey)&&void 0!==r?r:"",name:"metaKey",onChange:n=>{t(M(F({},e),{[n.target.name]:n.target.value}))}})),c().createElement(j,{entries:null!==(o=e.meta)&&void 0!==o?o:[],onUpdate:n=>{t(M(F({},e),{meta:n}))}}))}))})(),i})()));
//# sourceMappingURL=module.js.map