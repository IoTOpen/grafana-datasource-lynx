define(["@grafana/runtime","lodash","react","@grafana/ui","@grafana/data"],((e,t,n,a,r)=>(()=>{"use strict";var l={305:e=>{e.exports=r},545:t=>{t.exports=e},388:e=>{e.exports=a},980:e=>{e.exports=t},650:e=>{e.exports=n}},o={};function i(e){var t=o[e];if(void 0!==t)return t.exports;var n=o[e]={exports:{}};return l[e](n,n.exports,i),n.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var c={};return(()=>{i.r(c),i.d(c,{plugin:()=>q});var e=i(545),t=i(980);function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},r=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),r.forEach((function(t){n(e,t,a[t])}))}return e}function r(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}class l extends e.DataSourceWithBackend{fetchInstallations(){return(0,e.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/installationinfo`}).then((e=>e.data))}fetchFunctions(t,n){const a=n?Object.keys(n).map((e=>`${encodeURIComponent(e)}=${encodeURIComponent(n[e])}`)).join("&"):"";return(0,e.getBackendSrv)().datasourceRequest({method:"GET",url:`${this.settings.url}/api/v2/functionx/${t}?${a}`}).then((e=>e.data))}query(n){const l=(0,e.getTemplateSrv)(),o=n.targets.map((e=>r(a({},e),{installationId:e.installationVariable?(0,t.toNumber)(l.replace(e.installationVariable)):e.installationId,meta:e.meta.map((e=>({key:l.replace(e.key),value:l.replace(e.value)})),e)})));return super.query(r(a({},n),{targets:o}))}findMetaQuery(n,a){if(""===n.metaKey||"0"===n.installationId||""===n.installationId)return Promise.resolve([]);let r=(0,t.toNumber)(n.installationId);if("string"==typeof n.installationId&&n.installationId.includes("$")){const a=(0,e.getTemplateSrv)().replace(n.installationId);r=(0,t.toNumber)(a)}if(isNaN(r))return Promise.reject(`Invalid installation id: ${n.installationId} => ${r}`);const l=n.meta?n.meta.reduce(((e,t)=>(""!==t.key&&""!==t.value&&(e[t.key]=t.value),e)),{}):{};return this.fetchFunctions(r,l).then((e=>e.reduce(((e,t)=>!e.find((e=>e.text===t.meta[n.metaKey]))&&t.meta[n.metaKey]?[...e,{text:t.meta[n.metaKey],value:t.meta[n.metaKey]}]:e),[]))).then((e=>e))}metricFindQuery(e,t){return"installation"===(e.queryMode?e.queryMode:"functionMeta")?this.fetchInstallations().then((e=>e.reduce(((e,t)=>[...e,{text:t.name,value:t.id}]),[]))):this.findMetaQuery(e,t)}constructor(e){super(e),n(this,"settings",void 0),this.settings=e}}var o=i(650),u=i.n(o),s=i(388);const m=({type:e,tooltip:t,label:n,placeholder:a,name:r,value:l,onChange:o,labelWidth:i="auto",width:c})=>u().createElement(s.InlineField,{label:n,labelWidth:i,tooltip:t,grow:!0},u().createElement(s.Input,{type:e,name:r,placeholder:a,value:l,onChange:o,width:c})),p=({label:e,value:t,name:n,onChange:a,labelWidth:r="auto"})=>u().createElement(s.InlineFieldRow,null,u().createElement(s.InlineField,{label:e,labelWidth:r},u().createElement(s.InlineSwitch,{value:t,name:n,onChange:a})));function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function b(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){d(e,t,n[t])}))}return e}function y(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const f={installationId:0,type:"",meta:[{key:"type",value:""}]},g=({isLoading:e,installations:t,installation:n,onSelection:a})=>{const r=(0,o.useMemo)((()=>t.map((e=>({label:e.name,value:e})))),[t]),l=(0,o.useMemo)((()=>({label:n.name,value:n})),[n]),i=(0,o.useCallback)(((e,t)=>{var n,a;const r=t.toLowerCase();var l;return null!==(l=null===(a=e.value)||void 0===a||null===(n=a.name)||void 0===n?void 0:n.toLowerCase().includes(r))&&void 0!==l&&l}),[]);return u().createElement("div",{className:"gf-form-inline"},u().createElement(s.Select,{isLoading:e,placeholder:"Installation",noOptionsMessage:"No available installations",filterOption:i,width:65,options:r,menuPlacement:"bottom",onChange:e=>{var n;a(null!==(n=e.value)&&void 0!==n?n:t[0])},value:l}))};function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){v(e,t,n[t])}))}return e}function O(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const j=({data:e,keys:t,values:n,onUpdate:a,onDelete:r})=>{const l=(0,o.useMemo)((()=>t?t.map((e=>({label:e,value:e}))):[]),[t]),i=(0,o.useMemo)((()=>n?n.map((e=>({label:e,value:e}))):[]),[n]),c=(0,o.useMemo)((()=>({label:e.key,value:e.key})),[e]),m=(0,o.useMemo)((()=>({label:e.value,value:e.value})),[e]),p=(0,o.useCallback)((t=>{a(O(h({},e),{key:t.value}))}),[e,a]),d=(0,o.useCallback)((t=>{a(O(h({},e),{value:t.value}))}),[e,a]),b=(0,o.useCallback)((t=>{a(O(h({},e),{key:t}))}),[e,a]),y=(0,o.useCallback)((t=>{a(O(h({},e),{value:t}))}),[e,a]),f=(0,o.useCallback)((e=>{e.preventDefault(),r()}),[r]);return u().createElement("div",{className:"gf-form-inline"},u().createElement("div",{className:"gf-form"},u().createElement("span",{className:"gf-form-label query-keyword"},"key"),u().createElement(s.Select,{width:30,options:l,onChange:p,onCreateOption:b,value:c,isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"meta key"}),u().createElement("span",{className:"gf-form-label query-keyword"},"match"),u().createElement(s.Select,{width:30,options:i,onChange:d,onCreateOption:y,value:m,isSearchable:!0,allowCustomValue:!0,menuPlacement:"bottom",placeholder:"wildcard match"}),u().createElement(s.Button,{variant:"destructive",onClick:f,icon:"trash-alt"})))},E=({entries:e,onUpdate:t,hints:n})=>{const a=(0,o.useCallback)((n=>{const a=e.filter(((e,t)=>t!==n));t(a)}),[e,t]),r=(0,o.useCallback)((n=>{t([...e,{key:"",value:""}]),n.preventDefault()}),[e,t]),l=(0,o.useCallback)(((n,a)=>{const r=e.map(((e,t)=>t===n?a:e));t(r)}),[e,t]);return u().createElement(s.VerticalGroup,null,u().createElement("div",{className:"gf-form-inline,ui-list"},e.map(((e,t)=>{var r;return u().createElement(j,{key:t,data:e,onDelete:()=>{a(t)},onUpdate:e=>l(t,e),keys:n?Object.keys(n):[],values:n&&null!==(r=n[e.key])&&void 0!==r?r:[]})}))),u().createElement("div",{className:"gf-form-inline",style:{paddingBottom:10}},u().createElement(s.Button,{onClick:r,icon:"plus"},"Add filter")))};function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function P(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){w(e,t,n[t])}))}return e}function k(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const S=u().createElement(u().Fragment,null,"Group series by some meta key or payload ",u().createElement("code",null,"msg")," field. Defaults to Function ID."),C=u().createElement(u().Fragment,null,"This will name series based on some meta key.",u().createElement("br",null),"Defaults to ",u().createElement("code",null,"name"),"."),D=u().createElement(u().Fragment,null,"Using this field will join matching functions with the same filter, but the type changed to this field. The msg field will be overwritten by messages matching this type, linked through ",u().createElement("code",null,"device_id")," meta key. Useful for eg. joining positional data. ",u().createElement("br",null),"This field is only applied on table data."),I=({query:e,onChange:t,onRunQuery:n})=>{const a=a=>{t(k(P({},e),{[a.currentTarget.name]:a.currentTarget.checked})),n()};return u().createElement(u().Fragment,null,u().createElement(s.VerticalGroup,{spacing:"xs"},u().createElement(m,{name:"groupBy",labelWidth:15,label:"Group by",onChange:a=>{t(k(P({},e),{groupBy:a.currentTarget.value})),n()},value:e.groupBy,placeholder:"Function ID",tooltip:S}),u().createElement(m,{name:"nameBy",labelWidth:15,label:"Name by",placeholder:"name",onChange:a=>{t(k(P({},e),{nameBy:a.currentTarget.value})),n()},value:e.nameBy,tooltip:C}),u().createElement(s.HorizontalGroup,{align:"flex-start",spacing:"xs"},u().createElement(p,{label:"As table data",value:e.tabledata,name:"tabledata",onChange:a,labelWidth:15}),e.tabledata&&u().createElement(s.VerticalGroup,{spacing:"xs",align:"flex-start"},u().createElement(m,{placeholder:"eg. latitude",name:"messageFrom",labelWidth:20,label:"Message from",onChange:a=>{t(k(P({},e),{messageFrom:a.currentTarget.value})),n()},value:e.messageFrom,tooltip:D}),u().createElement(m,{labelWidth:20,placeholder:"device_id",name:"linkKey",label:"Linked with",onChange:a=>{t(k(P({},e),{linkKey:a.currentTarget.value})),n()},value:e.linkKey}),u().createElement(p,{label:"Meta as fields",labelWidth:20,value:e.metaAsFields,name:"metaAsFields",onChange:a}),e.metaAsFields&&u().createElement(p,{label:"Add device meta",labelWidth:20,name:"joinDeviceMeta",value:e.joinDeviceMeta,onChange:a}))),u().createElement(p,{label:"Current state only",value:e.stateOnly,name:"stateOnly",onChange:a})))},M=({value:t,onSelection:n})=>{const a=(0,e.getTemplateSrv)().getVariables().map((e=>({label:e.name,value:`\${${e.name}}`})));var r;return u().createElement("div",{className:"gf-form-inline"},u().createElement(s.Select,{placeholder:"Variable",noOptionsMessage:"No available variables",width:65,options:a,menuPlacement:"bottom",onChange:e=>n(null!==(r=e.value)&&void 0!==r?r:""),value:t}))};function T(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function x(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){T(e,t,n[t])}))}return e}function F(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function K(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function N(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){K(e,t,n[t])}))}return e}function V(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const q=new(i(305).DataSourcePlugin)(l).setConfigEditor((({onOptionsChange:e,options:t})=>{var n;const{jsonData:a,secureJsonData:r,secureJsonFields:l}=t,[i,c]=u().useState(!1);var d;return(0,o.useEffect)((()=>{if(void 0!==t.jsonData.apiKey&&""!==t.jsonData.apiKey){c(!0);let n=b({},a);delete n.apiKey,e(y(b({},t),{secureJsonData:y(b({},r),{apiKey:t.jsonData.apiKey}),jsonData:n}))}}),[]),u().createElement(s.VerticalGroup,{spacing:"none"},u().createElement(m,{label:"URL",value:t.jsonData.url||"",name:"url",placeholder:"Enter URL, eg. https://lynx.iotopen.se",onChange:n=>{e(y(b({},t),{jsonData:y(b({},a),{[n.target.name]:n.target.value})}))},labelWidth:15,width:40}),u().createElement(p,{labelWidth:15,label:"OAuth2 Passthru",name:"oauthPassThru",value:t.jsonData.oauthPassThru||!1,onChange:n=>{e(y(b({},t),{jsonData:y(b({},a),{[n.currentTarget.name]:n.currentTarget.checked})}))}}),!t.jsonData.oauthPassThru&&u().createElement(m,{label:"API Key",labelWidth:15,name:"apiKey",value:null!==(d=null===(n=r)||void 0===n?void 0:n.apiKey)&&void 0!==d?d:"",onChange:n=>{e(y(b({},t),{secureJsonData:y(b({},r),{[n.target.name]:n.target.value})}))},placeholder:l.apiKey?"Configured":"Enter API Key",width:70,type:"password"}),i&&!l.apiKey&&u().createElement(s.HorizontalGroup,{width:"100%"},u().createElement(s.Alert,{title:"Secure the API Key",severity:"error"},u().createElement(s.VerticalGroup,null,u().createElement("p",null,"The API key has migrated to a secure location. ",u().createElement("br",null),"Please press save to migrate the key to the secure store and get rid of this message.")))))})).setQueryEditor((({onChange:e,query:t,onRunQuery:n,datasource:a})=>{const[r,l]=(0,o.useState)([]),[i,c]=(0,o.useState)(!0),m=(0,o.useMemo)((()=>{let n=t;return void 0===n.installationId&&(n=x({},n,f),e(n)),n}),[t,e]),[d,b]=(0,o.useState)([]),[y,v]=(0,o.useState)(!1),[h,O]=(0,o.useState)({id:0,name:"",client_id:0}),j=((e,t)=>{const n=(0,o.useRef)();return(0,o.useCallback)((()=>{void 0!==n.current&&window.clearTimeout(n.current),n.current=window.setTimeout(e,250)}),[e,250])})(n);(0,o.useEffect)((()=>{a.fetchInstallations().then((e=>{let n=e.find((e=>e.id===t.installationId));void 0===n&&0===e.length&&(n={id:0,name:"No installations available",client_id:0}),void 0===n&&e.length>0&&(n=e[0]),O(n),l(e)})).finally((()=>{c(!1)}))}),[]),(0,o.useEffect)((()=>{0!==h.id&&(v(!0),a.fetchFunctions(Number(h.id)).then((e=>{b(e),j()})).finally((()=>{v(!1)})))}),[v,h,b,a,j]);const w=(0,o.useCallback)((t=>{e(F(x({},m),{meta:t})),j()}),[e,m,j]);(0,o.useEffect)((()=>{0!==h.id&&h.id!==m.installationId&&e(F(x({},m),{installationId:h.id}))}),[h,m,e]);const P=(0,o.useMemo)((()=>{const e={};for(const t of d){void 0===e.type?e.type=[t.type]:-1===e.type.indexOf(t.type)&&e.type.push(t.type);for(const n in t.meta)void 0===e[n]&&(e[n]=[]),-1===e[n].indexOf(t.meta[n])&&e[n].push(t.meta[n])}return e}),[d]),k=t=>{e(F(x({},m),{installationVariable:t}))};return u().createElement("div",{className:"section gf-form-group"},u().createElement(s.InlineFieldRow,null,void 0===m.installationVariable?u().createElement(g,{isLoading:i||y,installations:r,installation:h,onSelection:O}):u().createElement(M,{value:m.installationVariable,onSelection:k}),u().createElement(p,{label:"From variable",name:"useVariable",value:void 0!==m.installationVariable,onChange:e=>{e.currentTarget.checked?k(""):k(void 0)}})),u().createElement(E,{entries:m.meta||[],onUpdate:w,hints:P}),u().createElement(I,{query:t,onChange:e,onRunQuery:j}))})).setVariableQueryEditor((({query:e,onChange:t})=>{const n=(0,o.useMemo)((()=>void 0===e.queryMode||""===e.queryMode?V(N({},e),{queryMode:"meta",installationId:"0",meta:[],metaKey:""}):e),[e]),a=e=>{t(V(N({},n),{[e.target.name]:e.target.value}))};var r,l;return u().createElement(s.VerticalGroup,{spacing:"xs"},u().createElement(s.HorizontalGroup,{spacing:"xs"},u().createElement(s.InlineFieldRow,null,u().createElement(s.InlineField,{label:"Query mode",labelWidth:15},u().createElement(s.RadioButtonGroup,{options:[{label:"Meta values",value:"meta"},{label:"Installations",value:"installation"}],value:n.queryMode,onChange:e=>{t(V(N({},n),{queryMode:null!=e?e:"meta"}))}})))),"meta"===n.queryMode&&u().createElement(s.VerticalGroup,null,u().createElement(s.HorizontalGroup,null,u().createElement(m,{label:"Installation ID",placeholder:"ID",value:void 0===n.installationId?"0":n.installationId.toString(),name:"installationId",onChange:a,labelWidth:15}),u().createElement(m,{label:"Meta key",placeholder:"name",labelWidth:15,value:null!==(r=e.metaKey)&&void 0!==r?r:"",name:"metaKey",onChange:a})),u().createElement(E,{entries:null!==(l=n.meta)&&void 0!==l?l:[],onUpdate:e=>{t(V(N({},n),{meta:e}))}})))}))})(),c})()));
//# sourceMappingURL=module.js.map